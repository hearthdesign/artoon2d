{% extends 'artoon2d_blog/base.html' %}
{% load cloudinary %}
{% block title %}{{ post.title|truncatechars:60 }}{% endblock %}
{# SEO Meta Tags #}
{% block seo %}
<link rel="canonical" href="{{ canonical_url }}">
<meta name="description" content="{{ post.content|truncatechars:160 }}">

<meta property="og:title" content="{{ post.title }}">
<meta property="og:description" content="{{ post.content|truncatechars:160 }}">
<meta property="og:type" content="article">
{% if post.image %}
<meta property="og:image" content="{{ post.image.url }}">
{% endif %}
{% endblock %}

{% block content %}
<!-- Like button -->
<form method="post" action="{% url 'like_post' post.pk %}" class="likes-form">
    {% csrf_token %}
    <button type="submit">
        {% if user in post.likes.all %}
            ‚ù§Ô∏è Unlike
        {% else %}
            ü§ç Like
        {% endif %}
    </button>
    <span class="like-count">{{ post.likes.count }} likes</span>
</form>

<article>
    <h2>{{ post.title }}</h2>

    {# Show author and created date #}
    <p><strong>By:</strong> {{ post.author }} | <strong>Published:</strong> 
        {{ post.created_at|date:"F j, Y" }}</p>
    <p><em>{{ post.created_at|timesince }} ago</em></p>

    {# Follow button include #}
    {% include 'artoon2d_blog/components/follow_button.html'
        with target_user=post.author is_following=post.author.is_following 
        follower_count=post.author.follower_count %}

    {# Updated date if different from created date #}
    {% if post.updated_at > post.created_at %}
        <p><em>Updated on {{ post.updated_at|date:"F j, Y" }}</em></p>
    {% endif %}

    {# Category and theme if exist #}
    {% if post.category %}
        <p><strong>Category:</strong> {{ post.category.name }}</p>
    {% endif %}
    {% if post.theme %}
        <p><strong>Theme:</strong> {{ post.theme }}</p>
    {% endif %}

    {# Post content with linebreaks #}
    <div>{{ post.content|linebreaks }}</div>

    {# Post image #}
    {% if post.image %}
    <div>
        {% cloudinary post.image width=600 crop="scale" 
        alt=post.title class="post-img" loading="lazy" %}
    {% else %}
        <img src="{% static 'default-image.jpg' %}" alt="No image" class="post-img">
    </div>
    {% endif %}

    {# Edit link for author #}
    {% if user == post.author %}
        <a href="{% url 'post_update' post.pk %}">Edit Post</a>
    {% endif %}

    {# Tags if exist #}
    {% if post.tags.exists %}
        <p><strong>Tags:</strong>
        {% for tag in post.tags.all %}
            {{ tag.name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
        </p>
    {% endif %}

    {# Link to go back to post list #}
    <p><a href="{% url 'post_list' %}">‚Üê Back to all posts</a></p>
</article>

{% endblock %}